<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
	body {
		font-family: "Roboto Light", "Arial", sans-serif;
	}

	#container {
		width: 30em;
		background: #fff;
		margin-left: auto;
		margin-right: auto;
		padding-left: 1em;
		padding-right: 1em;
	}


	table {
		border-spacing: 4px;
	}

	td {
		background-color: #ccc;
		border-radius: 2px;
		padding: 8px;
		width: 1em;
		text-align: center;
		vertical-align: middle;
	}


	table#guesses td:nth-child(1) {
		background-color: #000;
		color: #fff;
	}
	table#guesses td:nth-child(7) {
		background-color: #98d092;
	}
	table#guesses td:nth-child(8) {
		background-color: #d9cb8b;
	}
</style>

</head>
<body>
<div id="container">
<h1>Mastermind Wordle</h1>

<select id="language">
	<option value = "cro">Croatian</option>
	<option value = "eng">English</option>
</select>

<button type="button" onclick="random_word()">Start New Game</button>

<p/>

<input type="hidden" id="guessword" onkeydown="guess_word_on_key_down(event.keyCode);"
/>
<input type="hidden" id="btn_guess" value="Guess" onclick="guess_word();" />

<p id="wrong_guess">
</p>

<div id="game_end">
</div>

<div style="float: left;margin-right:10px">
<table id="guesses">
<tr id="g1"></tr>
<tr id="g2"></tr>
<tr id="g3"></tr>
<tr id="g4"></tr>
<tr id="g5"></tr>
<tr id="g6"></tr>
<tr id="g7"></tr>
<tr id="g8"></tr>
<tr id="g9"></tr>
</table>
</div>

<div style="float: left;">
<table>
<tr id="abc1"></tr>
<tr id="abc2"></tr>
<tr id="abc3"></tr>
<tr id="abc4"></tr>
<tr id="abc5"></tr>
<tr id="abc6"></tr>
<tr id="abc7"></tr>
<tr id="abc8"></tr>
<tr id="abc9"></tr>
<tr id="abc10"></tr>
</table>
</div>

<script type="text/javascript" src="dictionary.js"></script>

<script>

function lang() {
	var select = document.getElementById('language');
	return select.options[select.selectedIndex].value;
}

function word_list() {
	return lang() == "cro" ? word_list_cro : word_list_eng;
}

function alphabet() {
	return lang() == "cro" ? alphabet_cro : alphabet_eng;
}

function get_word(idx) {
	return word_list()[idx];
}

function word_cnt() {
	return word_list().length;
}

function word_len(w) {
	if (lang() != "cro")
		return w.length;
		
	w = w.toLowerCase();
	ret = 0;
	for (i = 0; i < w.length - 1; ++i, ++ret) {
		if ((w[i] == 'l' && w[i + 1] == 'j') ||
		    (w[i] == 'n' && w[i + 1] == 'j') ||
			(w[i] == 'd' && w[i + 1] == 'ž'))
		{
			++i;
		}
	}
	return ret + 1;
}

function to_char_list(w) {
	is_cro = lang() == "cro";
	w = w.toUpperCase();
	ret = [];
	for (i = 0; i < w.length; ++i) {
		if (is_cro && i < w.length - 1 && (
		    (w[i] == 'L' && w[i + 1] == 'J') ||
		    (w[i] == 'N' && w[i + 1] == 'J') ||
			(w[i] == 'D' && w[i + 1] == 'Ž')))
		{
			ret.push(w.substring(i, i + 2));
			++i;
		}
		else {
			ret.push(w.substring(i, i + 1));
		}
	}
	return ret;
}

const alphabet_eng = [ "", "a,b,c", "d,e,f", "g,h,i", "j,k,l", "m,n,o", "p,q,r", "s,t,u", "v,w,x", "w,z" ];
const alphabet_cro = [ "", "a,b,c", "č,ć,d", "dž,đ,e", "f,g,h", "i,j,k", "l,lj,m", "n,nj,o", "p,r,s", "š,t,u", "v,z,ž" ];

var word_idx = 0;
var word = "";
var guess_cnt = 0;
var guesses = [];

const magic_idx = 5461;

function encode_idx(idx) {
	let swapped_idx = ((idx & 0x7f) << 7) | (idx >> 7);
	return swapped_idx ^ magic_idx;
}

function decode_idx(idx) {
	idx = idx ^ magic_idx;
	let unswapped_idx = ((idx & 0x7f) << 7) | (idx >> 7);
	return unswapped_idx;
}

function set_hidden_word(idx) {
	word_idx = idx;
	word = get_word(idx).toUpperCase();
	guess_cnt = 1;
	guesses = [];
	guessword.setAttribute('type', 'text');
	btn_guess.setAttribute('type', 'button');
	for (var i = 1; i < 10; ++i) {
		var gk = "g" + i.toString();

		var cells = []
			.concat(i, "?????".split(""), [ "-", "-" ])
			.map(function(ch) { return "<td>" + ch + "</td>"} )
			.join("");;

		document.getElementById(gk).innerHTML = cells;
	}

	var alph = alphabet();
	for (var i = 1; i <= alph.length - 1; ++i) {
		var abck = "abc" + i.toString();

		var cells = alph[i].toUpperCase().split(",")
			.map(function(ch) { return "<td id='letter_" + ch + "'>" + ch + "</td>"} )
			.join("")		
		document.getElementById(abck).innerHTML = cells;
	}
	document.getElementById("abc10").style.display = lang() == "cro" ? "" : "none";
	game_end.innerHTML = "";
}

window.onload = function() {
	let idx = document.URL.indexOf('?');
	if (idx != -1) {
		let pairs = decodeURIComponent(document.URL.substring(idx+1, document.URL.length)).split('&');
		let nv0 = pairs[0].split('=');
		let nv1 = pairs[1].split('=');
		let v0 = nv0[1], v1 = nv1[1];
		if (nv0[0] != "idx")
			[v0, v1] = [v1, v0];
		set_hidden_word(decode_idx(v0));
		guessword.value = v1;
		guess_word();
	}
	else {
		random_word();
	}
};

function random_word() {
	set_hidden_word(parseInt(Date.now()) % word_cnt());
}

function chk_word(w) {
	document.getElementById("wrong_guess").innerHTML = "";

	if (word_len(w) != 5) {
		document.getElementById("wrong_guess").innerHTML = w + " is not 5 letter word";
		return false;
	}
	w = w.toLowerCase();
	var lb = 0, ub = word_cnt() - 1;
	do {
		var mid = parseInt((lb + ub) / 2);
		var s = get_word(mid);
		if (s == w)
			return true;
		if (w < s)
			ub = mid - 1;
		else
			lb = mid + 1;
	}
	while (lb <= ub);

	document.getElementById("wrong_guess").innerHTML = w + " is not in dictionary";
	return false;
}

function match_word(w) {
	wl = to_char_list(w);
	wordl = to_char_list(word);
	const sk = [], sw = [];
	var sz = 0, g = 0;
	for (let i = 0; i < wl.length; ++i) {
		if (wl[i] == wordl[i])
			++g;
		else {
			sk[sz] = wordl[i];
			sw[sz] = wl[i];
			++sz;
		}
	}
	if (g == 5)
		return [5, 0];
	sk.sort();
	sw.sort();
	var y = 0;
	var ki = 0, wi = 0;
	while (ki < sz && wi < sz) {
		if (sk[ki] < sw[wi]) ++ki;
		else if (sk[ki] > sw[wi]) ++wi;
		else ++y, ++ki, ++wi;
	}
	return [g, y];
}

function guess_word() {
	var s = guessword.value;
	if (chk_word(s)) {
		guesses.push(s);
		s = s.toUpperCase();
		var m = match_word(s);
		var gk = "g" + guess_cnt.toString();
		var cells = []
			.concat(guess_cnt, s.split(""), m)
			.map(function(ch) { return '<td>' + ch + '</td>'} )
			.join('');
		document.getElementById(gk).innerHTML = cells;
		if (m[0] == 5) {
			game_end.innerHTML = compose_game_end();
		}
		else if (++guess_cnt == 10) {
				guessword.setAttribute('type', 'hidden');
				btn_guess.setAttribute('type', 'hidden');
			game_end.innerHTML = compose_game_end();
		}
	}
	document.getElementById("guessword").value = "";
}

function guess_word_on_key_down(keyCode) {
	document.getElementById('wrong_guess').innerHTML = '';
	if (keyCode == 13) guess_word();
}

function compose_game_end() {
	let win = guess_cnt < 10;
	let guess_1 = encodeURIComponent(guesses[0]);
	let ret = "<h3>Game End</h3>";
	ret += "<p>";
	if (win) ret += + guess_cnt + " tries to guess, well done!";
	else ret += "You lose, correct word is " + word;
	ret += "</p>";
	ret += "<h3>Challenge a Friend</h3>";
	ret += "<p>https://cimott.github.io?idx=" + encode_idx(word_idx).toString() + "&guess1=" + guess_1 + "</p>";
	return ret;
}

</script>

</div>
</body>
</html>